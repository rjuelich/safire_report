#!/bin/bash

csv=$1
study_home=$2
project=$3

scriptsdir="/eris/sbdp/GSP_Subject_Data/SCRIPTS/RC_API"
nsub=1
gentime="`date`"

for olid in `awk -F , '{print $2}' ${csv} | sort | uniq`
do
	if [ ! -e ${study_home}/${olid}/redcap/${olid}_demos_scales.csv ]
	then
		${scriptsdir}/GenoPheno_cohort_1sub.sh ${olid} > ${study_home}/${olid}/redcap/${olid}_redcap_cohort.csv
		${scriptsdir}/GenoPheno_dx_1sub.sh ${olid} > ${study_home}/${olid}/redcap/${olid}_redcap_dx.csv
		${scriptsdir}/GenoPheno_CoverInfo_1sub.sh ${olid} > ${study_home}/${olid}/redcap/${olid}_demos_scales.csv
	fi
done

cat /eris/sbdp/GSP_Subject_Data/SCRIPTS/gits/safire_package/HTML_TEMPLATES/cp_template.html | sed "s/_gentime_/${gentime}/g" | sed "s/_project_/${project}/g"

echo ""
echo ""
echo ""

for mri in `awk -F , '{print $3}' ${csv}`
do
	#for projectX in Taplin_Ongur FEP
	#do
	#	if [ `grep -c ${mri} ${study_home}/.${projectX}_sublist` -gt 0 ]
	#	then
	#		project=${projectX}
	#	fi
	#done
 
	vis=`grep ${mri} ${csv} | awk -F , '{print $1}'`
	mri_date=`echo ${mri} | awk -F _ '{print $1}' | sed 's/^\([0-9][0-9]\)\([0-9][0-9]\)\([0-9][0-9]\)/20\1-\2-\3/g'`
	mri_secs=`date -d ${mri_date} +%s`

	olid=`grep ${mri} ${csv} | awk -F , '{print $2}'`
	cohort=`cat ${study_home}/${olid}/redcap/${olid}_redcap_cohort.csv | grep [1-3]$ | awk -F , '{ if ($3=="1") print "Patient"; else if ($3=="2") print "Control"; else if ($3=="3") print "Relative"}' | sort | uniq | paste -s -d \; -`
	dx=`cat ${study_home}/${olid}/redcap/${olid}_redcap_dx.csv | awk -F , '{ for (i=4; i<=NF; i++) if ($i==3) print i}' | tail -1 | sed -f ${scriptsdir}/DX_Lookup.sed -`

	#if [ `echo ${dx} | awk '{print length($1)}'` -lt 1 ] && [ ${cohort} = "Patient" ]
	#then
	#	dx=`${scriptsdir}/GenoPheno_dx_ALT_1sub.sh ${olid} | grep -A 1 scid | tail -1 | sed -f ${scriptsdir}/DX_Lookup.sed`
	#fi
	
	if [ `echo ${dx} | awk '{print length($1)}'` -lt 1 ] && [ ${cohort} = "Patient" ]
	then
		dx="`grep ${olid} /eris/sbdp/Data/PHOENIX/GENERAL/GENOPHENO/redcap/raw/GP_DX_ALT.csv | awk -F , '{print $3}' | tail -1`"
	fi
	
	sex=`cat ${study_home}/${olid}/redcap/${olid}_demos_scales.csv | awk -F , 'NR>1 {"date -d \""$4"\" +%s" | getline dt; print sqrt((dt-"'${mri_secs}'")*(dt-"'${mri_secs}'")), $5}' | sort -n | awk '{ if (length($2)>=1) print $0}' | head -1 | awk '{ if ($2=="1") print "M"; else if ($2=="2") print "F"}'`

	age=`cat ${study_home}/${olid}/redcap/${olid}_demos_scales.csv | awk -F , 'NR>1 {"date -d \""$4"\" +%s" | getline dt; print sqrt((dt-"'${mri_secs}'")*(dt-"'${mri_secs}'")), $6}' | sort -n | awk '{ if (length($2)>=1) print $0}' | head -1 | awk '{print $2}'`
	#age=`${scriptsdir}/GenoPheno_CoverInfo_1sub.sh ${olid} | grep ${mri} | awk -F , '{print $6}'`	
	#sex=`${scriptsdir}/GenoPheno_CoverInfo_1sub.sh ${olid} | grep ${mri} | awk -F , '{if ($5=="1") print "Male"; else if ($5=="2") print "Female"}'`	

	demos=`echo ${cohort},${dx},${age},${sex}`

	
	
	ymrs=`cat ${study_home}/${olid}/redcap/${olid}_redcap_scales_raw.csv | awk -F , 'NR>1 {"date -d \""$4"\" +%s" | getline dt; for ( i=7 ; i<=17 ; i++ ) j+=$i; print sqrt((dt-"'${mri_secs}'")*(dt-"'${mri_secs}'")), $4, j; j=0 }' | sort -n | awk '{ OFS=","; if (length($3)>=1) print $2, $3}' | head -1 | awk '{print $1}'`
	
	#ymrs=`cat ${study_home}/${olid}/redcap/${olid}_demos_scales.csv | awk -F , 'NR>1 {"date -d \""$4"\" +%s" | getline dt; print sqrt((dt-"'${mri_secs}'")*(dt-"'${mri_secs}'")), $7, $8, $9, $10, $11}' | sort -n | awk '{ if (length($2)>=1) print $0}' | head -1 | awk '{print $2}'`

	madrs=`cat ${study_home}/${olid}/redcap/${olid}_redcap_scales_raw.csv | awk -F , 'NR>1 {"date -d \""$4"\" +%s" | getline dt; for ( i=18 ; i<=27 ; i++ ) j+=$i; print sqrt((dt-"'${mri_secs}'")*(dt-"'${mri_secs}'")), j; j=0}' | sort -n | awk '{ OFS=","; if (length($2)>=1) print $2}' | head -1 | awk '{print $1}'`
	
	#madrs=`cat ${study_home}/${olid}/redcap/${olid}_demos_scales.csv | awk -F , 'NR>1 {"date -d \""$4"\" +%s" | getline dt; print sqrt((dt-"'${mri_secs}'")*(dt-"'${mri_secs}'")), $7, $8, $9, $10, $11}' | sort -n | awk '{ if (length($3)>=1) print $0}' | head -1 | awk '{print $3}'`

	panss=`cat ${study_home}/${olid}/redcap/${olid}_redcap_scales_raw.csv | awk -F , 'NR>1 {"date -d \""$4"\" +%s" | getline dt; for ( i=28 ; i<=34 ; i++ ) j+=$i ; for ( a=35 ; a<=41 ; a++ ) k+=$a; for ( b=42 ; b<=57 ; b++ ) l+=$b; print sqrt((dt-"'${mri_secs}'")*(dt-"'${mri_secs}'")), j, k, l; j=0; k=0; l=0}' | sort -n | awk '{ OFS=","; if (length($2)>=1) print $2, $3, $4}' | head -1 | awk '{OFS=","; print $1}'`
	
	#panss=`cat ${study_home}/${olid}/redcap/${olid}_demos_scales.csv | awk -F , 'NR>1 {"date -d \""$4"\" +%s" | getline dt; print sqrt((dt-"'${mri_secs}'")*(dt-"'${mri_secs}'")), $7, $8, $9, $10, $11}' | sort -n | awk '{ if (length($4)>=1) print $0}' | head -1 | awk '{OFS=","; print $4, $5, $6}'`

	scales=`echo ${ymrs},${madrs},${panss} | sed 's,20\([0-9][0-9]\)-\([0-9][0-9]\)-\([0-9][0-9]\),\1/\2/\3,g'`

	

	lsfg=`grep superiorfrontal ${study_home}/${olid}/mri/processed/fs450/${mri}/qc/INDIV_MAPS/${mri}_fssum_table.txt | awk '{printf "%.1f\n", $3}' | tail -1`
	rsfg=`grep superiorfrontal ${study_home}/${olid}/mri/processed/fs450/${mri}/qc/INDIV_MAPS/${mri}_fssum_table.txt | awk '{printf "%.1f\n", $5}' | tail -1`
	vbr=`grep VBR ${olid}/mri/processed/fs450/${mri}/qc/INDIV_MAPS/${mri}_bsv_table.txt | awk '{printf "%.4f,%.1f\n", $2, $4}'`

	echo '<tr width="100%" style="page-break-inside: avoid;"><td width=1% align=center><a href='PDFs/${mri}.pdf'>'${nsub}'</a></td><td width=5.5% align=center><a href="https://redcap.partners.org/redcap/redcap_v7.0.14/DataEntry/record_home.php?pid=5739&arm=1&id='${olid}'">'${olid}'</a></td><td align=center>'${vis}'</td><td width=13% align=center><a href="http://xnat.mclean.harvard.edu/data/archive/projects/'${project}'/subjects/'${olid}'/experiments/'${mri}'">'${mri}'</a></td>'
	
	echo ${demos} | awk -F , '{OFS=""; print "<td align=center width=5.5%>", $1, "</td>", "<td align=center width=5.5%>", $2, "</td>", "<td align=center width=3%>", $3, "</td>", "<td align=center width=3%>", $4, "</td>"}'

	echo ${scales} | awk -F , '{OFS=""; print "<td align=center width=6.33%>" "<a href=""https://redcap.partners.org/redcap/redcap_v7.0.14/DataEntry/record_home.php?pid=5877&arm=1&id='${olid}'" ">", $1, "</a></td>", "<td align=center width=3%>", $2, "</td>", "<td align=center width=3%>", $3, "</td>", "<td align=center width=3%>", $4, "</td>", "<td align=center width=3%>", $5, "</td>", "<td align=center width=3%>", $6, "</td>"}'

	if [ `echo ${vbr} | awk -F , '{ if ($2>=95) print 2; else print 0}'` -gt 1 ]
	then
		echo ${vbr} | awk -F , '{OFS=""; print "<td align=center width=6% bgcolor=#F44336>", $1, "</td>", "<td align=center width=6% bgcolor=#F44336>", $2, "</td>"}'
	else
		echo ${vbr} | awk -F , '{OFS=""; print "<td align=center width=6%>", $1, "</td>", "<td align=center width=6%>", $2, "</td>"}'
	fi

	if [ `echo ${lsfg} | awk -F , '{ if ($1<=5) print 2; else print 0}'` -gt 1 ]
	then
		echo ${lsfg} | awk -F , '{OFS=""; print "<td align=center width=6% bgcolor=#F44336>", $1, "</td>"}'
	else
		echo ${lsfg} | awk -F , '{OFS=""; print "<td align=center width=6%>", $1, "</td>"}'
	fi

	if [ `echo ${rsfg} | awk -F , '{ if ($1<=5) print 2; else print 0}'` -gt 1 ]
	then
		echo ${rsfg} | awk -F , '{OFS=""; print "<td align=center width=6% bgcolor=#F44336>", $1, "</td>"}'
	else
		echo ${rsfg} | awk -F , '{OFS=""; print "<td align=center width=6%>", $1, "</td>"}'
	fi
	
	echo "</tr>"

	nsub=`expr $nsub + 1`
	
#	if [ ${nsub} = 67 ] || [ ${nsub} = 135 ] || [ ${nsub} = 204 ] || [ ${nsub} = 271 ] || [ ${nsub} = 339 ] || [ ${nsub} = 404 ] || [ ${nsub} = 480 ]
#	then
#		echo "</table>"
#		echo ""
#		echo ""
#		echo '<table class="TFtable" border="1" cellspacing="0" cellpadding="2" width="1200px" style="border-collapse: collapse; margin:auto;">'
#		
#		echo '<tr width="100%"><th bgcolor=#999999 width="2%">#</th><th bgcolor=#999999 width="6.5%">OLID</th><th bgcolor=#999999 width="10%">MCLID</th><th colspan=4 bgcolor=#999999 width="25%">Demographics</th><th colspan=5 bgcolor=#999999 width="25%">Clinical Scales</th><th bgcolor=#999999 colspan=2 width="15%">VBR</th><th bgcolor=#999999 colspan=2 width="15%">SFG Thickness</th></tr>'
#
#		echo '<tr width="100%"><td bgcolor=#999999 width="2%"></td><td bgcolor=#999999 width="6.5%"></td><td bgcolor=#999999 width="10%"></td><td align=center bgcolor=#999999 width="6.5%">Cohort</td><td bgcolor=#999999 align=center width="6.5%">DX</td><td bgcolor=#999999 align=center width="6.5%">Age</td><td bgcolor=#999999 align=center width="6.5%">Sex</td><td align=center bgcolor=#999999 width="5%">YMRS</td><td bgcolor=#999999 align=center width="5%">MADRS</td><td bgcolor=#999999 align=center width="5%">PANSS+</td><td bgcolor=#999999 align=center width="5%">PANSS-</td><td bgcolor=#999999 align=center width="5%">PANSSg</td><td bgcolor=#999999 align=center width="7.5%">Raw</td><td bgcolor=#999999 align=center width="7.5%">%-ile</td><td bgcolor=#999999 align=center width="7.5%">LH %</td><td bgcolor=#999999 align=center width="7.5%">RH %</td></tr>'
#
#	fi


done

echo "</table>"
echo "</body>"
echo "</html>"
